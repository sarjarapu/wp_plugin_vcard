name: CI

on:
  pull_request:
  push:
    branches: [ main, master ]

jobs:
  dependencies:
    name: Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, iconv, json, mbstring, pdo

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: wordpress/wp-content/plugins/minisite-manager/vendor
        key: ${{ runner.os }}-php-8.4-composer-${{ hashFiles('wordpress/wp-content/plugins/minisite-manager/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-8.4-composer-

    - name: Install dependencies
      run: cd wordpress/wp-content/plugins/minisite-manager && composer install --prefer-dist --no-progress

    - name: Security audit
      run: |
        cd wordpress/wp-content/plugins/minisite-manager
        composer audit --no-interaction || {
          EXIT_CODE=$?
          # Exit code 2 = abandoned packages (warnings, not errors)
          # Exit code 1 = security vulnerabilities (errors)
          if [ $EXIT_CODE -eq 2 ]; then
            echo "⚠ Abandoned packages detected (warnings only)"
            echo "These are transitive dependencies and acceptable if reviewed."
            exit 0
          else
            echo "✗ Security vulnerabilities found!"
            exit $EXIT_CODE
          fi
        }

  test:
    name: Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: minisite_test
          MYSQL_USER: minisite
          MYSQL_PASSWORD: minisite
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=10

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, iconv, json, mbstring, pdo
        coverage: xdebug

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: wordpress/wp-content/plugins/minisite-manager/vendor
        key: ${{ runner.os }}-php-8.4-composer-${{ hashFiles('wordpress/wp-content/plugins/minisite-manager/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-8.4-composer-

    - name: Install dependencies
      run: cd wordpress/wp-content/plugins/minisite-manager && composer install --prefer-dist --no-progress

    - name: Install MySQL client
      run: sudo apt-get update && sudo apt-get install -y default-mysql-client

    - name: Wait for MySQL to be ready
      run: |
        echo "Waiting for MySQL to be ready..."
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -P 3307 -u minisite -pminisite --silent 2>/dev/null; then
            echo "MySQL is ready!"
            exit 0
          fi
          echo "Attempt $i/30: MySQL not ready yet, waiting..."
          sleep 2
        done
        echo "MySQL failed to start"
        exit 1

    - name: Run unit tests
      run: cd wordpress/wp-content/plugins/minisite-manager && composer test:unit

    - name: Run integration tests
      run: cd wordpress/wp-content/plugins/minisite-manager && composer test:integration
      env:
        MYSQL_HOST: 127.0.0.1
        MYSQL_PORT: 3307
        MYSQL_DATABASE: minisite_test
        MYSQL_USER: minisite
        MYSQL_PASSWORD: minisite

  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, iconv, json, mbstring, pdo

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: wordpress/wp-content/plugins/minisite-manager/vendor
        key: ${{ runner.os }}-php-8.4-composer-${{ hashFiles('wordpress/wp-content/plugins/minisite-manager/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-8.4-composer-

    - name: Install dependencies
      run: cd wordpress/wp-content/plugins/minisite-manager && composer install --prefer-dist --no-progress

    - name: Static analysis
      run: cd wordpress/wp-content/plugins/minisite-manager && composer analyze

    - name: Code style
      run: cd wordpress/wp-content/plugins/minisite-manager && composer lint
