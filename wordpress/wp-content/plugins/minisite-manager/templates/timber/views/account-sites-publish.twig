<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-theme="blue">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Publish Your Minisite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary:#2563EB; --on-primary:#fff;
      --secondary:#0EA5E9; --on-secondary:#03283A;
      --background:#F8FAFC; --on-background:#0F172A;
      --surface:#FFFFFF; --on-surface:#0F172A;
      --surface-1:#F1F5F9; --on-surface-variant:#475569;
      --outline:#CBD5E1; --outline-variant:#E2E8F0;
      --focus-ring: color-mix(in srgb, var(--primary) 40%, transparent);
      --surface-0:var(--surface);
    }
    :is(a,button,input,textarea,select):focus-visible {
      outline:none; box-shadow:0 0 0 2px var(--focus-ring), 0 0 0 4px white;
      border-radius:.5rem;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-[var(--background)] text-[var(--on-background)]">
  <main class="min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-3xl font-bold text-[var(--on-surface)]">Publish Your Minisite</h1>
            <p class="text-[var(--on-surface-variant)] mt-2">Choose your permanent URL and make your minisite live</p>
            {% if minisite_id %}
              <p class="text-xs text-[var(--on-surface-variant)] mt-1">Minisite ID: {{ minisite_id }}</p>
            {% endif %}
          </div>
          <a href="{{ function('home_url','/account/sites') }}" 
             class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--surface-1)] text-[var(--on-surface)] ring-1 ring-[var(--outline-variant)] hover:bg-[var(--surface)]">
            <i class="fa-solid fa-arrow-left"></i> Back to Sites
          </a>
        </div>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="mb-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800 hidden">
        <i class="fa-solid fa-exclamation-triangle mr-2"></i>
        <span id="error-text"></span>
      </div>

      <!-- Success Message -->
      <div id="success-message" class="mb-6 p-4 rounded-lg bg-green-50 border border-green-200 text-green-800 hidden">
        <i class="fa-solid fa-check-circle mr-2"></i>
        <span id="success-text"></span>
      </div>

      <!-- Publishing Steps -->
      <div class="space-y-8">
        <!-- Step 1: Slug Selection -->
        <div class="bg-[var(--surface)] rounded-2xl ring-1 ring-[var(--outline-variant)] p-8">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-8 h-8 rounded-full bg-[var(--primary)] text-[var(--on-primary)] flex items-center justify-center font-medium">1</div>
            <h2 class="text-xl font-semibold text-[var(--on-surface)]">Choose Your URL</h2>
          </div>
          
          <div class="space-y-6">
            <!-- Business Slug -->
            <div>
              <label for="business_slug" class="block text-sm font-medium text-[var(--on-surface)] mb-2">
                Business Slug <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input 
                  type="text" 
                  id="business_slug" 
                  name="business_slug" 
                  placeholder="e.g., acme-dental, lotus-textiles"
                  required
                  pattern="[a-z0-9\-]+"
                  title="Only lowercase letters, numbers, and hyphens allowed"
                  class="w-full rounded-lg bg-[var(--surface-1)] text-[var(--on-surface)] border border-[var(--outline-variant)] px-4 py-3 pr-12 focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--focus-ring)]"
                />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fa-solid fa-building text-[var(--on-surface-variant)]"></i>
                </div>
              </div>
            </div>

            <!-- Location Slug -->
            <div>
              <label for="location_slug" class="block text-sm font-medium text-[var(--on-surface)] mb-2">
                Location Slug <span class="text-[var(--on-surface-variant)]">(optional)</span>
              </label>
              <div class="relative">
                <input 
                  type="text" 
                  id="location_slug" 
                  name="location_slug" 
                  placeholder="e.g., dallas, mumbai, main-office"
                  pattern="[a-z0-9\-]+"
                  title="Only lowercase letters, numbers, and hyphens allowed"
                  class="w-full rounded-lg bg-[var(--surface-1)] text-[var(--on-surface)] border border-[var(--outline-variant)] px-4 py-3 pr-12 focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--focus-ring)]"
                />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fa-solid fa-map-marker-alt text-[var(--on-surface-variant)]"></i>
                </div>
              </div>
            </div>

            <!-- URL Preview -->
            <div id="url-preview" class="hidden p-4 rounded-lg bg-[var(--surface-1)] border border-[var(--outline-variant)]">
              <h3 class="text-sm font-medium text-[var(--on-surface)] mb-2">Your minisite will be available at:</h3>
              <p class="font-mono text-[var(--primary)] text-sm" id="preview-url"></p>
            </div>

            <!-- Availability Check -->
            <div id="availability-check" class="hidden">
              <button 
                type="button" 
                id="check-availability-btn"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--secondary)] text-[var(--on-secondary)] hover:brightness-95 font-medium"
              >
                <i class="fa-solid fa-search"></i>
                Check Availability
              </button>
              <div id="availability-result" class="mt-2 hidden"></div>
            </div>
          </div>
        </div>

        <!-- Step 2: Payment -->
        <div class="bg-[var(--surface)] rounded-2xl ring-1 ring-[var(--outline-variant)] p-8">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-8 h-8 rounded-full bg-[var(--primary)] text-[var(--on-primary)] flex items-center justify-center font-medium">2</div>
            <h2 class="text-xl font-semibold text-[var(--on-surface)]">Complete Payment</h2>
          </div>
          
          <div class="space-y-6">
            <!-- Pricing Info -->
            <div class="bg-[var(--surface-1)] rounded-lg p-6">
              <h3 class="font-semibold text-[var(--on-surface)] mb-4">What you get:</h3>
              <div class="space-y-3 text-sm text-[var(--on-surface-variant)]">
                <div class="flex items-center gap-3">
                  <i class="fa-solid fa-check text-green-500"></i>
                  <p>Permanent ownership of your chosen URL</p>
                </div>
                <div class="flex items-center gap-3">
                  <i class="fa-solid fa-check text-green-500"></i>
                  <p>1 year of public access to your minisite</p>
                </div>
                <div class="flex items-center gap-3">
                  <i class="fa-solid fa-check text-green-500"></i>
                  <p>Full editing and customization rights</p>
                </div>
                <div class="flex items-center gap-3">
                  <i class="fa-solid fa-check text-green-500"></i>
                  <p>1-month grace period for renewals</p>
                </div>
              </div>
            </div>

            <!-- Payment Button -->
            <div class="text-center">
              <button 
                type="button" 
                id="publish-button"
                class="inline-flex items-center gap-3 px-8 py-4 rounded-lg bg-[var(--primary)] text-[var(--on-primary)] shadow hover:brightness-95 disabled:opacity-50 disabled:cursor-not-allowed font-medium text-lg"
                disabled
              >
                <i class="fa-solid fa-credit-card" id="publish-icon"></i>
                <span id="publish-text">Publish for $99/year</span>
                <div id="publish-loading" class="hidden">
                  <i class="fa-solid fa-spinner fa-spin"></i>
                </div>
              </button>
              <p class="text-xs text-[var(--on-surface-variant)] mt-2">
                Secure payment powered by Stripe
              </p>
            </div>
          </div>
        </div>

        <!-- Reservation Timer -->
        <div id="reservation-timer" class="hidden bg-orange-50 border border-orange-200 rounded-lg p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="fa-solid fa-clock text-orange-500"></i>
              <div>
                <p class="font-medium text-orange-800">Slug Reserved</p>
                <p class="text-sm text-orange-700">Complete payment within <span id="timer-display">5:00</span> to secure your URL</p>
              </div>
            </div>
            <button id="cancel-reservation-btn" class="text-orange-600 hover:text-orange-800 text-sm font-medium">
              Cancel Reservation
            </button>
          </div>
        </div>

        <!-- Payment Processing -->
        <div id="payment-processing" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-center gap-3">
            <i class="fa-solid fa-spinner fa-spin text-blue-500"></i>
            <div>
              <p class="font-medium text-blue-800">Processing Payment</p>
              <p class="text-sm text-blue-700">Please wait while we process your payment...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let reservationTimer = null;
    let reservationEndTime = null;

    // URL Preview functionality
    function updateUrlPreview() {
      const businessSlug = document.getElementById('business_slug').value.trim();
      const locationSlug = document.getElementById('location_slug').value.trim();
      const previewDiv = document.getElementById('url-preview');
      const previewUrl = document.getElementById('preview-url');
      const availabilityCheck = document.getElementById('availability-check');
      
      if (businessSlug) {
        let url = `/b/${businessSlug}`;
        if (locationSlug) {
          url += `/${locationSlug}`;
        }
        previewUrl.textContent = window.location.origin + url;
        previewDiv.classList.remove('hidden');
        availabilityCheck.classList.remove('hidden');
      } else {
        previewDiv.classList.add('hidden');
        availabilityCheck.classList.add('hidden');
      }
    }

    // Auto-format slugs (lowercase, replace spaces with hyphens)
    function formatSlug(input) {
      input.addEventListener('input', function() {
        let value = this.value.toLowerCase();
        value = value.replace(/[^a-z0-9-]/g, '-');
        value = value.replace(/-+/g, '-');
        value = value.replace(/^-|-$/g, '');
        this.value = value;
        updateUrlPreview();
      });
    }

    // Check slug availability
    function checkAvailability() {
      const businessSlug = document.getElementById('business_slug').value.trim();
      const locationSlug = document.getElementById('location_slug').value.trim();
      
      if (!businessSlug) {
        showError('Please enter a business slug');
        return;
      }

      const button = document.getElementById('check-availability-btn');
      const result = document.getElementById('availability-result');
      
      button.disabled = true;
      button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';
      
      // Make AJAX call to check availability
      fetch('{{ function("admin_url", "admin-ajax.php") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          action: 'check_slug_availability',
          nonce: '{{ function("wp_create_nonce", "check_slug_availability") }}',
          business_slug: businessSlug,
          location_slug: locationSlug
        })
      })
      .then(response => response.json())
      .then(data => {
        button.disabled = false;
        button.innerHTML = '<i class="fa-solid fa-search"></i> Check Availability';
        
        if (data.success) {
          if (data.data.available) {
            result.innerHTML = '<div class="text-green-600"><i class="fa-solid fa-check-circle mr-2"></i>' + data.data.message + '</div>';
            document.getElementById('publish-button').disabled = false;
          } else {
            result.innerHTML = '<div class="text-red-600"><i class="fa-solid fa-times-circle mr-2"></i>' + data.data.message + '</div>';
            document.getElementById('publish-button').disabled = true;
          }
        } else {
          console.error('API Error:', data);
          showError(data.data || 'Failed to check availability');
          document.getElementById('publish-button').disabled = true;
        }
        
        result.classList.remove('hidden');
      })
    .catch(error => {
      button.disabled = false;
      button.innerHTML = '<i class="fa-solid fa-search"></i> Check Availability';
      showError('Network error. Please try again.');
      document.getElementById('publish-button').disabled = true;
    });
    }

    // Start reservation timer
    function startReservationTimer(expiresInSeconds = 300) {
      const timerDisplay = document.getElementById('timer-display');
      const reservationDiv = document.getElementById('reservation-timer');
      
      reservationDiv.classList.remove('hidden');
      reservationEndTime = Date.now() + (expiresInSeconds * 1000);
      
      reservationTimer = setInterval(() => {
        const now = Date.now();
        const remaining = reservationEndTime - now;
        
        if (remaining <= 0) {
          clearInterval(reservationTimer);
          timerDisplay.textContent = '0:00';
          showError('Reservation expired. Please check availability again.');
          reservationDiv.classList.add('hidden');
          document.getElementById('publish-button').disabled = false;
          return;
        }
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    // Cancel reservation
    function cancelReservation() {
      if (reservationTimer) {
        clearInterval(reservationTimer);
        reservationTimer = null;
      }
      
      document.getElementById('reservation-timer').classList.add('hidden');
      document.getElementById('publish-button').disabled = false;
      
      // TODO: Make AJAX call to cancel reservation on server
      showSuccess('Reservation cancelled. You can try again.');
    }

    // Show error message
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      errorText.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    // Show success message
    function showSuccess(message) {
      const successDiv = document.getElementById('success-message');
      const successText = document.getElementById('success-text');
      successText.textContent = message;
      successDiv.classList.remove('hidden');
      setTimeout(() => successDiv.classList.add('hidden'), 5000);
    }

    // Reset publish button to original state
    function resetPublishButton() {
      const button = document.getElementById('publish-button');
      const icon = document.getElementById('publish-icon');
      const text = document.getElementById('publish-text');
      const loading = document.getElementById('publish-loading');
      
      button.disabled = false;
      icon.classList.remove('hidden');
      text.classList.remove('hidden');
      loading.classList.add('hidden');
    }

    // Event listeners
    document.getElementById('business_slug').addEventListener('input', updateUrlPreview);
    document.getElementById('location_slug').addEventListener('input', updateUrlPreview);
    document.getElementById('check-availability-btn').addEventListener('click', checkAvailability);
    document.getElementById('cancel-reservation-btn').addEventListener('click', cancelReservation);
    
    document.getElementById('publish-button').addEventListener('click', function() {
      const button = document.getElementById('publish-button');
      const icon = document.getElementById('publish-icon');
      const text = document.getElementById('publish-text');
      const loading = document.getElementById('publish-loading');
      
      const businessSlug = document.getElementById('business_slug').value.trim();
      const locationSlug = document.getElementById('location_slug').value.trim();
      
      if (!businessSlug) {
        showError('Please enter a business slug');
        return;
      }
      
      // Show loading state
      button.disabled = true;
      icon.classList.add('hidden');
      text.classList.add('hidden');
      loading.classList.remove('hidden');
      
      // First, reserve the slug
      fetch('{{ function("admin_url", "admin-ajax.php") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          action: 'reserve_slug',
          nonce: '{{ function("wp_create_nonce", "reserve_slug") }}',
          business_slug: businessSlug,
          location_slug: locationSlug
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Start reservation timer with actual expiration time
          const expiresInSeconds = data.data.expires_in_seconds || 300;
          startReservationTimer(expiresInSeconds);
          
          // Show payment processing
          document.getElementById('payment-processing').classList.remove('hidden');
          
          // Create WooCommerce order and redirect to checkout
          fetch('{{ function("admin_url", "admin-ajax.php") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              action: 'create_minisite_order',
              nonce: '{{ function("wp_create_nonce", "create_minisite_order") }}',
              minisite_id: '{{ minisite_id|default("") }}',
              business_slug: businessSlug,
              location_slug: locationSlug,
              reservation_id: data.data.reservation_id
            })
          })
          .then(response => response.json())
          .then(orderData => {
            // Hide processing indicator
            document.getElementById('payment-processing').classList.add('hidden');
            
            if (orderData.success) {
              showSuccess('Order created! Redirecting to checkout...');
              // Redirect to WooCommerce checkout
              setTimeout(() => {
                window.location.href = orderData.data.checkout_url;
              }, 1500);
            } else {
              showError(orderData.data || 'Failed to create order');
              resetPublishButton();
            }
          })
          .catch(error => {
            document.getElementById('payment-processing').classList.add('hidden');
            showError('Failed to create order. Please try again.');
            resetPublishButton();
          });
        } else {
          showError(data.data || 'Failed to reserve slug');
          resetPublishButton();
        }
      })
      .catch(error => {
        showError('Network error. Please try again.');
        button.disabled = false;
        icon.classList.remove('hidden');
        text.classList.remove('hidden');
        loading.classList.add('hidden');
      });
    });

    // Format slug inputs
    formatSlug(document.getElementById('business_slug'));
    formatSlug(document.getElementById('location_slug'));

    // Initial URL preview
    updateUrlPreview();
  </script>
</body>
</html>
