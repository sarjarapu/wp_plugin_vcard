<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-theme="blue">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ page_title }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary:#2563EB; --on-primary:#fff;
      --background:#F8FAFC; --on-background:#0F172A;
      --surface:#FFFFFF; --on-surface:#0F172A;
      --surface-1:#F1F5F9; --on-surface-variant:#475569;
      --outline-variant:#E2E8F0;
      --surface-0:var(--surface);
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="antialiased bg-[var(--background)] text-[var(--on-background)]">
  <main class="min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
      <div class="flex items-start justify-between gap-4 mb-8">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold text-[var(--on-surface)]">{{ page_title }}</h1>
          <p class="mt-2 text-[var(--on-surface-variant)]">Manage minisite subscriptions and payments.</p>
        </div>
      </div>

      <!-- Pending Orders Section -->
      <div class="mb-8">
        <div class="rounded-2xl ring-1 ring-[var(--outline-variant)] bg-[var(--surface-0)] p-6">
          <h2 class="text-xl font-semibold text-[var(--on-surface)] mb-4">
            <i class="fa-solid fa-clock text-orange-500 mr-2"></i>
            Pending Payments
          </h2>
          <p class="text-[var(--on-surface-variant)] mb-6">Orders waiting for UPI payment verification:</p>
          
          {% if pending_orders is empty %}
            <div class="text-center py-8">
              <i class="fa-solid fa-check-circle text-green-500 text-4xl mb-4"></i>
              <p class="text-[var(--on-surface-variant)]">No pending orders.</p>
            </div>
          {% else %}
            <div class="overflow-x-auto">
              <table class="w-full border-collapse">
                <thead>
                  <tr class="border-b border-[var(--outline-variant)]">
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Order</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Customer</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Amount</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Minisite</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Payment Method</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Date</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for order in pending_orders %}
                    <tr class="border-b border-[var(--outline-variant)] hover:bg-[var(--surface-1)]">
                      <td class="py-3 px-4">
                        <div class="font-semibold text-[var(--on-surface)]">#{{ order.order_number }}</div>
                        <div class="text-sm text-[var(--on-surface-variant)]">ID: {{ order.order_id }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <div class="text-[var(--on-surface)]">{{ order.customer_name }}</div>
                        <div class="text-sm text-[var(--on-surface-variant)]">{{ order.customer_email }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <div class="font-medium text-[var(--on-surface)]">{{ order.currency }} {{ order.total }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <div class="font-semibold text-[var(--on-surface)]">{{ order.slug }}</div>
                        <div class="text-sm text-[var(--on-surface-variant)]">ID: {{ order.minisite_id }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <div class="text-[var(--on-surface)]">{{ order.payment_method }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <div class="text-[var(--on-surface)]">{{ order.date_created }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <div class="flex items-center gap-2">
                          <button 
                            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-[var(--primary)] text-[var(--on-primary)] text-sm font-medium hover:brightness-95 activate-subscription-btn" 
                            data-order-id="{{ order.order_id }}"
                            data-nonce="{{ nonce }}"
                          >
                            <i class="fa-solid fa-play text-xs"></i>
                            Activate
                          </button>
                          <a 
                            href="{{ function('admin_url', 'post.php?post=' ~ order.order_id ~ '&action=edit') }}" 
                            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg border border-[var(--outline-variant)] text-[var(--on-surface)] text-sm font-medium hover:bg-[var(--surface-1)]"
                            target="_blank"
                          >
                            <i class="fa-solid fa-external-link text-xs"></i>
                            View Order
                          </a>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Completed Orders Section -->
      <div class="mb-8">
        <div class="rounded-2xl ring-1 ring-[var(--outline-variant)] bg-[var(--surface-0)] p-6">
          <h2 class="text-xl font-semibold text-[var(--on-surface)] mb-4">
            <i class="fa-solid fa-check-circle text-green-500 mr-2"></i>
            Active Subscriptions
          </h2>
          <p class="text-[var(--on-surface-variant)] mb-6">Recently completed orders with active subscriptions:</p>
          
          {% if completed_orders is empty %}
            <div class="text-center py-8">
              <i class="fa-solid fa-inbox text-gray-400 text-4xl mb-4"></i>
              <p class="text-[var(--on-surface-variant)]">No completed orders.</p>
            </div>
          {% else %}
            <div class="overflow-x-auto">
              <table class="w-full border-collapse">
                <thead>
                  <tr class="border-b border-[var(--outline-variant)]">
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Order</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Customer</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Minisite</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Expires</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Status</th>
                    <th class="text-left py-3 px-4 font-medium text-[var(--on-surface)]">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for order in completed_orders %}
                    <tr class="border-b border-[var(--outline-variant)] hover:bg-[var(--surface-1)]">
                      <td class="py-3 px-4">
                        <div class="font-semibold text-[var(--on-surface)]">#{{ order.order_number }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <div class="text-[var(--on-surface)]">{{ order.customer_name }}</div>
                        <div class="text-sm text-[var(--on-surface-variant)]">{{ order.customer_email }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <div class="font-semibold text-[var(--on-surface)]">{{ order.slug }}</div>
                      </td>
                      <td class="py-3 px-4">
                        {% if order.subscription %}
                          <div class="text-[var(--on-surface)]">{{ order.subscription.expires_at }}</div>
                        {% else %}
                          <div class="text-[var(--on-surface-variant)] italic">No subscription data</div>
                        {% endif %}
                      </td>
                      <td class="py-3 px-4">
                        {% if order.subscription %}
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                            {% if order.subscription.status == 'active' %}
                              bg-green-100 text-green-800
                            {% elseif order.subscription.status == 'expired' %}
                              bg-red-100 text-red-800
                            {% elseif order.subscription.status == 'grace_period' %}
                              bg-orange-100 text-orange-800
                            {% else %}
                              bg-gray-100 text-gray-800
                            {% endif %}">
                            {{ order.subscription.status|title }}
                          </span>
                        {% else %}
                          <div class="text-[var(--on-surface-variant)] italic">Unknown</div>
                        {% endif %}
                      </td>
                      <td class="py-3 px-4">
                        <a 
                          href="{{ function('admin_url', 'post.php?post=' ~ order.order_id ~ '&action=edit') }}" 
                          class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg border border-[var(--outline-variant)] text-[var(--on-surface)] text-sm font-medium hover:bg-[var(--surface-1)]"
                          target="_blank"
                        >
                          <i class="fa-solid fa-external-link text-xs"></i>
                          View Order
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle subscription activation
    document.querySelectorAll('.activate-subscription-btn').forEach(button => {
      button.addEventListener('click', function() {
        const orderId = this.dataset.orderId;
        const nonce = this.dataset.nonce;
        
        if (!confirm('Are you sure you want to activate this subscription? ' +
                     'This will make the minisite publicly accessible.')) {
          return;
        }
        
        this.disabled = true;
        this.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-xs"></i> Activating...';
        
        fetch('{{ function('admin_url', 'admin-ajax.php') }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            action: 'activate_minisite_subscription_admin',
            order_id: orderId,
            nonce: nonce
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Subscription activated successfully!');
            location.reload();
          } else {
            alert('Error: ' + (data.data || 'Failed to activate subscription'));
            this.disabled = false;
            this.innerHTML = '<i class="fa-solid fa-play text-xs"></i> Activate';
          }
        })
        .catch(error => {
          alert('Error: ' + error.message);
          this.disabled = false;
          this.innerHTML = '<i class="fa-solid fa-play text-xs"></i> Activate';
        });
      });
    });
  });
  </script>
</body>
</html>
